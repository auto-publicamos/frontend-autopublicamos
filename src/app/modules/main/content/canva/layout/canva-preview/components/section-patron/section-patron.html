<div class="mb-8">
  <div class="flex flex-col xl:flex-row xl:items-center justify-between mb-3 gap-4 xl:gap-0">
    <div class="flex items-center gap-2 justify-between xl:justify-start w-full xl:w-auto">
      <h3 class="text-sm font-bold text-neutral-800">Editor de Patrón</h3>

      <div class="flex items-center gap-2">
        <!-- Open Doc Button -->
        <button
          (click)="openDoc.emit()"
          class="flex items-center gap-2 px-3 py-1 bg-white border border-neutral-200 text-neutral-600 rounded-full text-xs font-medium hover:bg-neutral-50 hover:border-neutral-300 transition-all max-w-[120px]"
          [title]="docName() ? docName() : 'Seleccionar Documento'"
        >
          @if (docLoading()) {
            <svg
              class="animate-spin w-3 h-3 text-blue-600"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            <span>Cargando...</span>
          } @else {
            <icon-document class="w-3 h-3 text-blue-600 shrink-0"></icon-document>
            <span class="truncate">{{ docName() || 'Open Doc' }}</span>
          }
        </button>

        <button
          (click)="openKey.emit()"
          class="flex items-center justify-center p-1.5 bg-white border border-neutral-200 text-neutral-600 rounded-full hover:bg-neutral-50 hover:border-neutral-300 transition-all"
          title="Configurar API Key de Gemini"
        >
          <icon-key class="w-3.5 h-3.5 text-amber-500"></icon-key>
        </button>

        <button
          (click)="runAi.emit()"
          class="flex items-center justify-center p-1.5 bg-indigo-50 border border-indigo-200 text-indigo-600 rounded-full hover:bg-indigo-100 hover:border-indigo-300 transition-all shadow-xs w-8 h-8"
          title="Generar patrón con IA"
          [disabled]="aiLoading()"
        >
          @if (aiLoading()) {
            <svg
              class="animate-spin w-3.5 h-3.5"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
          } @else {
            <icon-sparkles class="w-3.5 h-3.5"></icon-sparkles>
          }
        </button>
      </div>
    </div>

    <div class="flex items-center gap-2 w-full xl:w-auto">
      <!-- Legend/Selector -->
      <div class="flex items-center p-1 gap-2 text-xs w-full xl:w-auto overflow-x-auto">
        @for (mode of modes(); track mode.value) {
          <button
            (click)="setMode(mode.value)"
            [class.ring-2]="currentMode() === mode.value"
            class="flex items-center gap-1.5 sm:gap-2 px-2 py-1 rounded-full border transition-all ring-offset-2 shrink-0 text-[10px] sm:text-xs"
            [ngClass]="{
              'bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100 ring-blue-300':
                mode.color === 'blue',
              'bg-pink-50 text-pink-700 border-pink-200 hover:bg-pink-100 ring-pink-300':
                mode.color === 'pink',
              'bg-amber-50 text-amber-700 border-amber-200 hover:bg-amber-100 ring-amber-300':
                mode.color === 'amber',
              'bg-neutral-100 text-neutral-600 border-neutral-300 hover:bg-neutral-200 ring-neutral-400':
                mode.color === 'neutral',
            }"
          >
            <div
              class="w-2 h-2 sm:w-2.5 sm:h-2.5 rounded-full"
              [ngClass]="{
                'bg-blue-500': mode.color === 'blue',
                'bg-pink-500': mode.color === 'pink',
                'bg-amber-500': mode.color === 'amber',
                'bg-neutral-400': mode.color === 'neutral',
              }"
            ></div>
            {{ mode.label }}
          </button>
        }
      </div>
    </div>
  </div>

  <div class="flex gap-1.5 overflow-x-auto pb-4 scrollbar-thin scrollbar-thumb-neutral-200">
    @for (val of pattern(); track idx; let idx = $index) {
      <div
        (click)="applyMode(idx)"
        class="flex-none w-10 h-16 rounded border cursor-pointer flex flex-col items-center justify-center text-[10px] font-bold text-white transition-all hover:brightness-110 shadow-sm relative overflow-hidden"
        [ngClass]="{
          'bg-blue-500 border-blue-600': getModeColor(val) === 'blue',
          'bg-pink-500 border-pink-600': getModeColor(val) === 'pink',
          'bg-amber-500 border-amber-600': getModeColor(val) === 'amber',
          'bg-neutral-400 border-neutral-500': getModeColor(val) === 'neutral',
        }"
      >
        <span class="z-10">{{ idx + 1 }}</span>
        <!-- Texture/Glass effect -->
        <div
          class="absolute inset-0 bg-linear-to-br from-white/20 to-transparent pointer-events-none"
        ></div>
      </div>
    }
  </div>
</div>
